<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KarriereGenie — Tasks</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2a; --text:#e6eefb; --muted:#9db2cf; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap { max-width:1024px; margin:0 auto; padding:24px }
    h1 { margin:0 0 10px 0; font-size:22px }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .card { background:var(--card); border:1px solid #26334d; border-radius:12px; padding:14px }
    .pill { padding:6px 10px; border-radius:999px; background:#1d2a44; border:1px solid #2b3b5a; color:var(--text); cursor:pointer; }
    .pill.active { outline:2px solid var(--accent); }
    .muted { color:var(--muted) }
    .counts { display:flex; gap:10px; flex-wrap:wrap }
    .counts .kv { background:#0e1626; border:1px solid #2b3b5a; border-radius:10px; padding:10px 12px; }
    .kv b { display:block; font-size:18px }
    table { width:100%; border-collapse: collapse; margin-top:10px }
    th, td { padding:10px; border-bottom:1px solid #26334d; vertical-align:top }
    th { text-align:left; font-weight:600; color:var(--muted) }
    a { color: var(--accent); text-decoration: none }
    .label { display:inline-block; padding:3px 8px; border:1px solid #2b3b5a; border-radius:999px; margin-right:6px; margin-bottom:4px; background:#0e1626; color:#c7d2fe; font-size:12px }
    .toolbar { display:flex; gap:8px; align-items:center }
    button { padding:8px 12px; border-radius:10px; border:1px solid #2b3b5a; background:#1d2a44; color:var(--text); cursor:pointer }
    footer { margin-top:20px; color:var(--muted); font-size:12px }
    .ok { color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>KarriereGenie — Task-Dashboard</h1>
      <div class="toolbar">
        <button id="btnRefresh">Aktualisieren</button>
        <span class="muted">Auto-Refresh: <span id="autoSec">30</span>s</span>
      </div>
    </div>

    <div class="card">
      <div id="counts" class="counts"></div>
      <div class="row" style="margin-top:10px">
        <span class="pill active" data-state="inbox">Inbox</span>
        <span class="pill" data-state="running">Running</span>
        <span class="pill" data-state="done">Done</span>
        <span class="pill" data-state="failed">Failed</span>
      </div>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>Titel</th>
            <th style="width:220px">Labels</th>
            <th style="width:180px">Zeit</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="4" class="muted">Lade…</td></tr></tbody>
      </table>
    </div>

    <footer>
      <span class="muted">Quelle: brain/tasks_*.json (Read-only). Build: 2025-10-14 12:49:34 +02:00</span>
    </footer>
  </div>

<script>
const S = (sel, el=document) => el.querySelector(sel);
const SS = (sel, el=document) => [...el.querySelectorAll(sel)];
const fmt = (s) => s ? new Date(s).toLocaleString() : '';
const stateToLabel = { inbox:'kg-inbox', running:'kg-running', done:'kg-done', failed:'kg-failed' };

async function getJson(path){
  try{
    const r = await fetch(path, { cache: 'no-store' });
    if(!r.ok) return null;
    return await r.json();
  }catch{ return null }
}

async function loadAll(){
  const summary = await getJson('brain/tasks_summary.json');
  const inbox   = await getJson('brain/tasks_inbox.json');
  const done    = await getJson('brain/tasks_done.json');
  // running/failed optional – werden aus brain/tasks?state=... nach Bedarf künftig ergänzt
  const counts = summary || { inbox: (inbox?.items?.length||0), running: 0, done: (done?.items?.length||0), failed: 0, total: 0 };
  renderCounts(counts);
  const active = S('.pill.active')?.dataset.state || 'inbox';
  renderTable(active, inbox, done);
}

function renderCounts(c){
  const el = S('#counts'); el.innerHTML='';
  const kv = (k,v,cls='') => `<div class="kv"><b class="${cls}">${v}</b><div class="muted">${k}</div></div>`;
  el.insertAdjacentHTML('beforeend', kv('Inbox', c.inbox||0));
  el.insertAdjacentHTML('beforeend', kv('Running', c.running||0));
  el.insertAdjacentHTML('beforeend', kv('Done', c.done||0, 'ok'));
  el.insertAdjacentHTML('beforeend', kv('Failed', c.failed||0, 'err'));
  el.insertAdjacentHTML('beforeend', kv('Total', c.total||((c.inbox||0)+(c.running||0)+(c.done||0)+(c.failed||0))));
}

function renderTable(state, inbox, done){
  const rows = S('#rows'); rows.innerHTML='';
  let items = [];
  if(state==='inbox') items = inbox?.items||[];
  else if(state==='done') items = done?.items||[];
  else items = []; // running/failed: später ergänzen

  if(!items.length){
    rows.innerHTML = `<tr><td colspan="4" class="muted">Keine Einträge.</td></tr>`;
    return;
  }
  for(const it of items){
    const labels = (it.labels||[]).map(n => `<span class="label">${n}</span>`).join('');
    const link = it.url ? `<a href="${it.url}" target="_blank" rel="noopener">${it.title||'(ohne Titel)'}</a>` : (it.title||'(ohne Titel)');
    rows.insertAdjacentHTML('beforeend', `
      <tr>
        <td>#${it.id||''}</td>
        <td>${link}</td>
        <td>${labels}</td>
        <td><div><span class="muted">erstellt</span> ${fmt(it.created_at)}</div>
            <div><span class="muted">aktualisiert</span> ${fmt(it.updated_at)}</div></td>
      </tr>`);
  }
}

function bind(){
  SS('.pill').forEach(p => p.addEventListener('click', () => {
    SS('.pill').forEach(x => x.classList.remove('active'));
    p.classList.add('active');
    loadAll();
  }));
  S('#btnRefresh').addEventListener('click', loadAll);
  // Auto-Refresh
  let sec = 30;
  setInterval(()=>{ sec--; if(sec<=0){ sec=30; loadAll(); } S('#autoSec').textContent=String(sec); }, 1000);
}

document.addEventListener('DOMContentLoaded', () => { bind(); loadAll(); });
</script>
<div id="kg-status-badge" style="position:fixed;right:12px;bottom:12px;padding:6px 10px;border-radius:12px;border:1px solid var(--kg-badge-border,#D1D5DB);box-shadow:0 3px 10px rgba(0,0,0,.35);font:600 13px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--kg-badge-fg,#111827);background:var(--kg-badge-bg,rgba(243,244,246,.96));backdrop-filter:saturate(1.1) blur(2px);-webkit-backdrop-filter:saturate(1.1) blur(2px);">
  <span>Last sync: <strong id="kg-sync-ts">…</strong></span>
</div>
<script>
(async () => {
  try {
    const r = await fetch('brain/status.json', { cache: 'no-store' });
    const s = await r.json();
    const dt = (s && (s.updated_utc || s.updated || s.ts)) || null;
    document.getElementById('kg-sync-ts').textContent = dt ? new Date(dt).toLocaleString() : 'n/a';
  } catch {
    document.getElementById('kg-sync-ts').textContent = 'n/a';
  }
})();
</script>
<script id="kg-status-badge-v3">
(async () => {
  const el = document.getElementById('kg-sync-ts');
  if (!el) return;

  function pickTs(obj){
    const keys = ['updated_utc','updated','ts','generated_at','last_sync_utc','lastUpdated','last_update','lastModified'];
    for(const k of keys){ if(obj && obj[k]){ const t=Date.parse(obj[k]); if(!isNaN(t)) return t; } }
    return 0;
  }

  const q = `?v=${Date.now()}`;
  const files = [
    'brain/site_sync.json','brain/status.json',
    'brain/tasks_summary.json',
    'brain/tasks_done.json',
    'brain/tasks_inbox.json'
  ];

  async function tryJson(){
    for(const f of files){
      try{
        const r = await fetch(f + q, { cache: 'no-store' });
        if(!r.ok) continue;
        const s = await r.json().catch(()=>null);
        const t = pickTs(s);
        if (t) return t;
      }catch{}
    }
    return 0;
  }

  async function tryHeaders(){
    let best = 0;
    for(const f of files){
      try{
        const r = await fetch(f + q, { method: 'HEAD', cache: 'no-store' });
        const h = r.headers;
        const v = h.get('last-modified') || h.get('date'); // beide sind OK
        if (v){ const t = Date.parse(v); if(!isNaN(t)) best = Math.max(best, t); }
      }catch{}
    }
    return best;
  }

  const ts = (await tryJson()) || (await tryHeaders());
  el.textContent = ts ? new Date(ts).toLocaleString() : 'n/a';
})();
</script>
<script id="kg-badge-theme">
(() => {
  const el = document.getElementById('kg-status-badge');
  if (!el) return;
  function apply(){
    const dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const bg = dark ? 'rgba(17,24,39,.92)' : 'rgba(243,244,246,.96)';   // sehr dunkles vs. sehr helles Grau
    const fg = dark ? '#E5E7EB' : '#111827';                             // helles Grau vs. fast schwarz
    const br = dark ? '#334155' : '#D1D5DB';                             // Rahmen
    el.style.setProperty('--kg-badge-bg', bg);
    el.style.setProperty('--kg-badge-fg', fg);
    el.style.setProperty('--kg-badge-border', br);
  }
  apply();
  try { window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', apply); } catch {}
})();
</script>
<style id="kg-badge-css">
#kg-status-badge, #kg-status-badge * {
  color: var(--kg-badge-fg,#111827) !important;
}
</style>
  
<script>
(async function(){
  const el = document.getElementById('last-sync');
  if(!el) return;
  function setBadge(txt, ok){ 
    el.textContent = txt;
    el.style.borderColor = ok ? '#0a0' : '#a00';
    el.style.color = ok ? '#0a0' : '#a00';
  }
  async function fetchJson(u){
    const r = await fetch(u, {cache:'no-store'}); if(!r.ok) throw new Error(r.status);
    return r.json();
  }
  try{
    let ts = null;
    try{
      const j = await fetchJson('./brain/site_sync.json');
      ts = j.ts || j.timestamp || j.updated || j.updated_at || j.synced_at || null;
    }catch{}
    if(!ts){
      const s = await fetchJson('./brain/status.json');
      ts = s && (s.site_sync_ts || s.ts || s.updated_at || s.last_update || null);
    }
    if(!ts) { setBadge('Last sync: n/a', false); return; }
    // hübsch formatieren, aber robust falls Browser ohne Intl
    let txt = 'Last sync: ' + ts;
    try{
      const d = new Date(ts);
      txt = 'Last sync: ' + new Intl.DateTimeFormat(undefined, {dateStyle:'medium', timeStyle:'short'}).format(d);
    }catch{}
    setBadge(txt, true);
  }catch{
    setBadge('Last sync: n/a', false);
  }
})();
</script>

<!-- SYNC-BADGE-PATCH v2.2 (single badge, cleanup) -->
<style>
  #last-sync-badge{
    position:fixed;left:.5rem;top:.5rem;z-index:9999;
    font:12px/1.2 system-ui,Segoe UI,Roboto,Arial,sans-serif;
    padding:2px 8px;border:1px solid;border-radius:999px;cursor:pointer;
  }
</style>
<script>
(function(){
  try{
    // Safety: alle "Last sync:"-Nodes außer unserem Badge entfernen
    Array.prototype.slice.call(document.querySelectorAll('body *')).forEach(function(el){
      if(el.id==='last-sync-badge') return;
      var t=(el.textContent||'').trim();
      if(/^last sync:/i.test(t)) { try{ el.parentNode.removeChild(el); }catch(e){} }
    });
    // Legacy-Span explizit weg
    var legacy=document.getElementById('last-sync'); if(legacy&&legacy.parentNode){ legacy.parentNode.removeChild(legacy); }

    // Unser (einziger) Badge
    var b=document.getElementById('last-sync-badge');
    if(!b){ b=document.createElement('span'); b.id='last-sync-badge'; document.body.appendChild(b); }

    function setBadge(ts, source){
      var color='#a00', txt='Last sync: n/a', iso='n/a', rel='n/a';
      if(ts){
        iso=ts;
        try{
          var d=new Date(ts), now=new Date();
          var mins=Math.floor((now-d)/60000);
          var tf=new Intl.DateTimeFormat(undefined,{timeStyle:'short'});
          var df=new Intl.DateTimeFormat(undefined,{dateStyle:'medium'});
          rel=df.format(d)+', '+tf.format(d);
          if(mins<=10){ color='#0a0'; }
          else if(mins<=60){ color='#a80'; }
          else { color='#a00'; }
          txt='Last sync: '+tf.format(d);
        }catch(e){ txt='Last sync: '+ts; color='#0a0'; }
      }
      b.textContent=txt;
      b.style.borderColor=color; b.style.color=color;
      b.title='Source: '+source+'\nISO: '+iso+'\nLocal: '+rel;
      b.onclick=function(){ window.open('./brain/site_sync.json','_blank'); };
    }

    // Daten laden
    (function(){
      var ts=null, src='site_sync.json';
      var fetchJson=function(u,cb){ var x=new XMLHttpRequest(); x.open('GET',u,true); x.setRequestHeader('Cache-Control','no-store'); x.onreadystatechange=function(){ if(x.readyState===4){ try{ cb(x.status, x.responseText?JSON.parse(x.responseText):null); }catch(e){ cb(x.status,null); } } }; x.send(); };
      fetchJson('./brain/site_sync.json', function(s,a){
        if(s===200 && a){ ts=a.ts||a.timestamp||a.updated||a.updated_at||a.synced_at||null; }
        if(!ts){
          src='status.json';
          fetchJson('./brain/status.json', function(s2,b){ if(s2===200 && b){ ts=b.site_sync_ts||b.ts||b.updated_at||b.last_update||null; } setBadge(ts, src); });
        } else { setBadge(ts, src); }
      });
    })();
  }catch(e){ /* noop */ }
})();
</script>
<!-- HEALTH-BADGE v1 -->
<style>
  #health-badge{
    position:fixed;right:.5rem;top:.5rem;z-index:9999;
    font:12px/1.2 system-ui,Segoe UI,Roboto,Arial,sans-serif;
    padding:2px 8px;border:1px solid;border-radius:999px;cursor:pointer;
  }
</style>
<script>
(function(){
  try{
    // unser Badge
    var b=document.getElementById('health-badge');
    if(!b){ b=document.createElement('span'); b.id='health-badge'; document.body.appendChild(b); }
    function setBadge(color,text,title){
      b.textContent=text; b.style.borderColor=color; b.style.color=color; b.title=title||'';
      b.onclick=function(){ window.open('./brain/health.json','_blank'); };
    }
    function get(u,cb){
      var x=new XMLHttpRequest(); x.open('GET',u,true);
      try{x.setRequestHeader('Cache-Control','no-store');}catch(e){}
      x.onreadystatechange=function(){ if(x.readyState===4){ cb(x.status,x.responseText); } }; x.send();
    }
    get('./brain/health.json', function(status,body){
      var color='#a00', text='Health: n/a', title='no data';
      if(status===200 && body){
        var j=null; try{ j=JSON.parse(body); }catch(e){}
        if(j){
          var bOk = j.brain && j.brain.status===200 && j.brain.ok===true;
          var tOk = j.tasks && j.tasks.status===200 && j.tasks.ok===true;
          var score = (bOk?1:0)+(tOk?1:0);
          if(score===2){ color='#0a0'; text='Health: OK'; }
          else if(score===1){ color='#a80'; text='Health: WARN'; }
          else { color='#a00'; text='Health: FAIL'; }
          var ts = j.ts || 'n/a';
          var bt = j.brain ? ('brain '+j.brain.status+' ok='+j.brain.ok) : 'brain n/a';
          var tt = j.tasks ? ('tasks '+j.tasks.status+' ok='+j.tasks.ok) : 'tasks n/a';
          title = 'ts='+ts+'\n'+bt+'\n'+tt;
        }
      }
      setBadge(color,text,title);
    });
  }catch(e){ /* noop */ }
})();
</script>
</body>
</html>
