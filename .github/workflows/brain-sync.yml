name: Brain â†’ Site Sync

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: kg-site-brain-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      BASE: https://kg-brain.mindsparked-channel.workers.dev
    steps:
      - uses: actions/checkout@v4

      - name: Fetch brain artifacts
        run: |
          set -euo pipefail
          mkdir -p brain
          curl -fsSL "\https://kg-brain.mindsparked-channel.workers.dev/api/v1/status"            -o brain/status.json
          curl -fsSL "\https://kg-brain.mindsparked-channel.workers.dev/api/v1/context"           -o brain/context.md
          curl -fsSL "\https://kg-brain.mindsparked-channel.workers.dev/api/v1/tasks/summary"     -o brain/tasks_summary.json
          curl -fsSL "\https://kg-brain.mindsparked-channel.workers.dev/api/v1/tasks?state=inbox" -o brain/tasks_inbox.json
          curl -fsSL "\https://kg-brain.mindsparked-channel.workers.dev/api/v1/tasks?state=done"  -o brain/tasks_done.json

      - name: Commit if changed
        run: |
          set -e
          if git diff --quiet -- brain/status.json brain/context.md brain/tasks_summary.json brain/tasks_inbox.json brain/tasks_done.json; then
            echo "No changes."
            exit 0
          fi
          git config user.name  "kg-site-bot"
          git config user.email "actions@users.noreply.github.com"
          git add brain/status.json brain/context.md brain/tasks_summary.json brain/tasks_inbox.json brain/tasks_done.json
          git commit -m "chore(site): sync brain artifacts + tasks"
          git push